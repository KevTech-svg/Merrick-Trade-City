<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merrick Trade City — User Panel</title>
<link rel="icon" type="image/png" href="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");
  :root{--bg:#0c0f1f;--accent:#7c5cff;--accent2:#6a4bff;--muted:#bfbfcf}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{display:flex;min-height:100vh;background:radial-gradient(circle at top,var(--bg),#05060d);color:#fff}
  .sidebar{width:260px;padding:22px;background:linear-gradient(180deg, rgba(124,92,255,0.92), rgba(15,12,41,0.95));display:flex;flex-direction:column;justify-content:space-between;border-right:1px solid rgba(255,255,255,0.06)}
  .profile-card{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}
  .menu{display:flex;flex-direction:column;gap:6px}
  .menu button{background:none;border:none;color:#fff;padding:12px;border-radius:10px;text-align:left;cursor:pointer;font-weight:600}
  .menu button.active{background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .main{flex:1;padding:18px;display:flex;flex-direction:column;gap:16px;overflow:auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px}
  .chart-box{height:420px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .input{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  footer{margin-top:10px;text-align:center;color:var(--muted)}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
  .modal-content{background:#0f0c29;padding:18px;border-radius:12px;width:94%;max-width:520px}
  @media(max-width:980px){.sidebar{width:100%;flex-direction:row;overflow:auto}.menu{flex-direction:row}}
</style>
</head>
<body><div class="sidebar" role="navigation">
  <div>
    <h2>User Panel</h2>
    <div class="profile-card card">
      <img id="profilePic" src="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg" alt="logo" />
      <div>
        <div id="userName">—</div>
        <small id="userBalance">Balance: —</small>
      </div>
    </div>
    <div class="menu" id="menu">
      <button data-section="dashboard" class="active">Dashboard</button>
      <button data-section="trading">Trading</button>
      <button data-section="history">Trade History</button>
    </div>
  </div>
  <div style="margin-top:14px">
    <button class="btn btn-primary" id="derivLoginBtn">Login with Deriv</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</div><div class="main">
  <!-- Dashboard -->
  <section id="dashboardSection" class="card">
    <h3>Welcome back, <span id="displayName">User</span></h3>
    <div class="chart-box" id="tvChartWrap"></div>
  </section>  <!-- Trading -->  <section id="tradingSection" style="display:none" class="card">
    <h3>Place Trade</h3>
    <label>Choose Symbol:</label>
    <select id="symbolSelect" class="input">
      <option value="R_100">R_100</option>
      <option value="R_25">R_25</option>
      <option value="frxEURUSD">EUR/USD</option>
      <option value="frxUSDJPY">USD/JPY</option>
      <option value="frxGBPUSD">GBP/USD</option>
      <option value="frxAUDUSD">AUD/USD</option>
    </select>
    <label>Stake:</label>
    <input id="tradeStake" class="input" type="number" value="1" />
    <label>Trade Type:</label>
    <select id="tradeType" class="input">
      <option value="CALL">CALL (Buy)</option>
      <option value="PUT">PUT (Sell)</option>
    </select>
    <button class="btn btn-primary" onclick="confirmTrade()">Execute Trade</button>
  </section>  <!-- Trade History -->  <section id="historySection" style="display:none" class="card">
    <h3>Trade History</h3>
    <div id="tradeHistory"></div>
  </section>  <footer><small class="small-muted">© 2025 Merrick Trade City — All rights reserved.</small></footer>
</div><!-- Confirmation Modal --><div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3>Confirm Trade</h3>
    <p id="confirmText"></p>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn" onclick="closeModal('confirmModal')">Cancel</button>
      <button class="btn btn-primary" id="confirmBtn">Confirm</button>
    </div>
  </div>
</div><script>
const DERIV_APP_ID = '109286';
let derivToken = null;
let ws = null;
let tradeHistory = [];
let currentTrade = null;

/* ====== UI Helpers ====== */
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function show(el){ if(el) el.style.display='block'; }
function hide(el){ if(el) el.style.display='none'; }
function openModal(id){ qs('#'+id).style.display='flex'; }
function closeModal(id){ qs('#'+id).style.display='none'; }

/* ====== Menu Switch ====== */
qsa('.menu button').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    qsa('.menu button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const section = btn.dataset.section;
    const map = {dashboard:'dashboardSection', trading:'tradingSection', history:'historySection'};
    Object.values(map).forEach(id => { const el = qs('#'+id); if(el) hide(el); });
    if(map[section]) show(qs('#'+map[section]));
  });
});

/* ====== Deriv Login ====== */
qs('#derivLoginBtn').addEventListener('click', ()=> {
  const state = Math.random().toString(36).slice(2);
  localStorage.setItem('deriv_oauth_state', state);
  const redirect = encodeURIComponent(location.origin + location.pathname);
  const url = https://oauth.deriv.com/oauth2/authorize?app_id=${DERIV_APP_ID}&response_type=token&state=${state}&redirect_uri=${redirect};
  window.location.href = url;
});

function grabTokenFromUrl(){
  const hash = window.location.hash;
  if(!hash) return null;
  const params = new URLSearchParams(hash.replace('#','?'));
  const token = params.get('access_token');
  const state = params.get('state');
  if(token && state===localStorage.getItem('deriv_oauth_state')){
    localStorage.setItem('deriv_token', token);
    history.replaceState(null,'',location.pathname);
    return token;
  }
  return null;
}

/* ====== Connect WS ====== */
function connectWS(){
  derivToken = localStorage.getItem('deriv_token');
  if(!derivToken) return;
  ws = new WebSocket(wss://ws.binaryws.com/websockets/v3?app_id=${DERIV_APP_ID});
  ws.onopen = ()=> { ws.send(JSON.stringify({ authorize: derivToken })); console.log('Connected to Deriv WS'); };
  ws.onmessage = msg=>{
    const data = JSON.parse(msg.data);
    if(data.authorize) {
      qs('#displayName').textContent = data.authorize.display_name || 'User';
      qs('#userBalance').textContent = 'Balance: ' + (data.authorize.balance||0);
    }
    if(data.transaction) console.log('Transaction update', data.transaction);
  };
  ws.onerror = e=>console.error('WS Error',e);
  ws.onclose = ()=>console.log('WS closed');
}

/* ====== Trade Execution ====== */
function confirmTrade(){
  const symbol = qs('#symbolSelect').value;
  const stake = parseFloat(qs('#tradeStake').value);
  const type = qs('#tradeType').value;
  if(!symbol || !stake || !type) return alert('Fill all fields');
  currentTrade = { symbol, stake, type };
  qs('#confirmText').textContent = You are about to ${type} ${symbol} with ${stake} Ksh. Confirm?;
  openModal('confirmModal');
}

qs('#confirmBtn').addEventListener('click', ()=>{
  closeModal('confirmModal');
  executeTrade(currentTrade);
});

function executeTrade(trade){
  if(!ws || ws.readyState!==WebSocket.OPEN) return alert('WebSocket not connected');
  const request = {
    buy: 1,
    price: trade.stake,
    parameters: {
      amount: trade.stake,
      basis: 'stake',
      contract_type: trade.type,
      currency: 'USD',
      symbol: trade.symbol,
      duration: 1,
      duration_unit: 'm'
    }
  };
  ws.send(JSON.stringify(request));
  tradeHistory.push({...trade, time:new Date().toLocaleString()});
  updateTradeHistory();
  alert(Trade sent: ${trade.type} ${trade.symbol} for ${trade.stake} Ksh);
}

function updateTradeHistory(){
  qs('#tradeHistory').innerHTML = tradeHistory.map(t=><div>${t.time}: ${t.type} ${t.symbol} (${t.stake} Ksh)</div>).join('');
}

/* ====== TradingView Embed ====== */
new TradingView.widget({
  container_id: "tvChartWrap",
  width: "100%",
  height: "100%",
  symbol: "OANDA:XAUUSD",
  interval: "60",
  timezone: "Etc/UTC",
  theme: "dark",
  style: "1",
  locale: "en",
  toolbar_bg: "#f1f3f6",
  enable_publishing: false,
  allow_symbol_change: true
});

/* ====== Startup ====== */
if(grabTokenFromUrl()) connectWS();
else if(localStorage.getItem('deriv_token')) connectWS();

function logout(){
  localStorage.removeItem('deriv_token');
  location.reload();
}
</script></body>
</html>

<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merrick Trade City — User Panel</title>
<link rel="icon" type="image/png" href="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");
  :root{--bg:#0c0f1f;--accent:#7c5cff;--accent2:#6a4bff;--muted:#bfbfcf}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{display:flex;min-height:100vh;background:radial-gradient(circle at top,var(--bg),#05060d);color:#fff}
  .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(6,8,20,0.9), rgba(6,8,20,0.95));z-index:9999;flex-direction:column;transition:opacity .5s,visibility .5s}
  .loading-hidden{opacity:0;visibility:hidden;pointer-events:none}
  .brand-glow{font-size:36px;font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;color:transparent}
  .loading-sub{margin-top:12px;color:var(--muted)}
  .sidebar{width:260px;padding:22px;background:linear-gradient(180deg, rgba(124,92,255,0.92), rgba(15,12,41,0.95));display:flex;flex-direction:column;justify-content:space-between;border-right:1px solid rgba(255,255,255,0.06)}
  .profile-card{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}
  .profile-card img{width:64px;height:64px;border-radius:50%;object-fit:cover;cursor:pointer}
  .menu{display:flex;flex-direction:column;gap:6px}
  .menu button{background:none;border:none;color:#fff;padding:12px;border-radius:10px;text-align:left;cursor:pointer;font-weight:600}
  .menu button.active{background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .main{flex:1;padding:18px;display:flex;flex-direction:column;gap:16px;overflow:auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px}
  .chart-box{height:420px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  .bots-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
  .bot-card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;text-align:center}
  .input{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  footer{margin-top:10px;text-align:center;color:var(--muted)}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
  .modal-content{background:#0f0c29;padding:18px;border-radius:12px;width:94%;max-width:520px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  @media(max-width:980px){.sidebar{width:100%;flex-direction:row;overflow:auto}.menu{flex-direction:row}}
</style>
</head>
<body><!-- Loading overlay --><div id="loadingOverlay" class="loading-overlay" role="status" aria-live="polite">
  <div class="brand-glow">Merrick Trade City</div>
  <div class="loading-sub" id="loadingSub">Connecting… please wait</div>
</div><!-- Sidebar --><div class="sidebar" role="navigation">
  <div>
    <h2>User Panel</h2>
    <div class="profile-card card">
      <img id="profilePic" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="avatar" onclick="onChangeProfilePic()" />
      <div>
        <div id="userName">—</div>
        <small id="userBalance">Balance: —</small>
        <small id="userEmail">—</small>
      </div>
    </div><div class="menu" id="menu">
  <button data-section="dashboard" class="active">Dashboard</button>
  <button data-section="freebots">Free Bots</button>
  <button data-section="dtrader">D-Trader</button>
  <button data-section="smart">Smart Analysis</button>
  <button data-section="analysis">Analysis Tool</button>
  <button data-section="signals">Signals</button>
  <button data-section="charts">Charts</button>
  <button data-section="copy">Copy Trading</button>
</div>

  </div>  <div style="margin-top:14px">
    <div style="margin-bottom:8px">
      <button class="btn btn-primary" id="githubLoginBtn">Connect GitHub</button>
    </div>
    <button class="btn" onclick="openTokenModal()">Deriv Token</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</div><!-- Main --><div class="main">
  <div id="dashboardSection" class="card section">
    <h3>Portfolio Overview</h3>
    <div class="chart-box">
      <canvas id="portfolioChart"></canvas>
    </div>
  </div>  <div id="freebotsSection" class="section card" style="display:none">
    <h3>Free Bots</h3>
    <div class="bots-grid" id="freeBotsGrid"></div>
  </div>  <div id="dtraderSection" class="section card" style="display:none">
    <h3>D-Trader (Demo)</h3>
    <p>Coming soon…</p>
  </div>  <div id="copySection" class="section card" style="display:none">
    <h3>Copy Trading</h3>
    <p>Coming soon…</p>
  </div>
</div><script>
/* ====== Config ====== */
const GITHUB_OWNER = 'KevTech-svg';
const GITHUB_REPO = 'merrick-data';
const USERS_PATH = 'users.json';
const ADMIN_BOTS_PATH = 'admin_bots.json';
const DERIV_APP_ID = '109286';

/* ====== Runtime state ====== */
let githubToken = localStorage.getItem('merrick_github_token') || null;
let usersData = {};
let adminBots = [];
let currentUserEmail = localStorage.getItem('merrick_current_user') || null;
let currentUser = null;
let portfolioChart = null;

/* ====== Safe query parsing ====== */
const urlParams = new URLSearchParams(window.location.search);
const acct1 = urlParams.get('acct1');
const token1 = urlParams.get('token1');
const cur1 = urlParams.get('cur1');

/* ====== Helpers ====== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const show = el => el && (el.style.display='block');
const hide = el => el && (el.style.display='none');
const openModal = id => qs('#'+id).style.display='flex';
const closeModal = id => qs('#'+id).style.display='none';

/* ====== Load & save users on GitHub ====== */
async function saveUsersToGitHub(){
  if(!githubToken) return;
  try{
    const content = btoa(JSON.stringify(usersData,null,2));
    await fetch(https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${USERS_PATH},{
      method:'PUT',
      headers:{'Authorization':'token '+githubToken,'Content-Type':'application/json'},
      body:JSON.stringify({message:'Update users',content})
    });
  }catch(e){console.error('GitHub save failed',e);}
}

async function loadUsersFromGitHub(){
  try{
    const res = await fetch(https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${USERS_PATH});
    usersData = await res.json();
  }catch(e){console.warn('Could not load users.json, initializing empty'); usersData={};}
}

/* ====== UI updates ====== */
function updateProfileUI(){
  if(!currentUser) return;
  qs('#userName').textContent = currentUser.name || '—';
  qs('#userBalance').textContent = 'Balance: ' + (currentUser.balance||'0');
  qs('#userEmail').textContent = currentUser.email || '—';
  qs('#profilePic').src = currentUser.avatar || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
}

function onChangeProfilePic(){
  const url = prompt('Paste image URL for your avatar:','');
  if(!url) return;
  currentUser.avatar = url;
  updateProfileUI();
  usersData[currentUser.email] = currentUser;
  if(githubToken) saveUsersToGitHub();
}

/* ====== Section switching ====== */
qsa('.menu button').forEach(btn=>{
  btn.onclick = ()=>{
    qsa('.menu button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    qsa('.section').forEach(s=>s.style.display='none');
    const sec = qs(#${btn.dataset.section}Section);
    show(sec);
  };
});

/* ====== Free bots rendering ====== */
async function loadBots(){
  try{
    const res = await fetch(https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${ADMIN_BOTS_PATH});
    adminBots = await res.json();
    const grid = qs('#freeBotsGrid');
    grid.innerHTML = '';
    adminBots.forEach(bot=>{
      const div = document.createElement('div');
      div.className='bot-card';
      div.innerHTML=<h4>${bot.name}</h4><p>${bot.desc}</p>;
      grid.appendChild(div);
    });
  }catch(e){console.warn('Could not load bots',e);}
}

/* ====== Portfolio chart ====== */
function initChart(){
  const ctx = qs('#portfolioChart').getContext('2d');
  const data = {labels:['BTC','ETH','XAU','USD'],datasets:[{label:'Balance',data:[500,300,200,100],backgroundColor:['#7c5cff','#6a4bff','#3e3c9f','#111']}]};
  portfolioChart = new Chart(ctx,{type:'bar',data,options:{responsive:true,plugins:{legend:{display:false}}}});
}

/* ====== Deriv token modal ====== */
function openTokenModal(){alert('Deriv token modal coming soon…');}
function logout(){localStorage.removeItem('merrick_current_user');location.reload();}

/* ====== Init ====== */
async function init(){
  await loadUsersFromGitHub();
  currentUser = usersData[currentUserEmail] || {name:'Guest',email:'guest@example.com',balance:0,avatar:''};
  updateProfileUI();
  await loadBots();
  initChart();
  hide(qs('#loadingOverlay'));
}

init();
</script>
  <script src="https://cdn.jsdelivr.net/npm/reconnecting-websocket@4.4.0/dist/reconnecting-websocket.min.js"></script><script>
/* ====== Deriv WebSocket Live Trading ====== */
const DERIV_APP_ID = 109286; // Your app id
let ws = null;
let activeSymbols = ['R_100','R_25','RDBEAR','RDBULL']; // Example tickers
let tickSubscriptions = {}; // Store active ticks
let portfolio = {balance:1000, trades:[]}; // Demo portfolio

function connectDeriv() {
    if(ws) ws.close();
    ws = new ReconnectingWebSocket('wss://ws.binaryws.com/websockets/v3?app_id='+DERIV_APP_ID);

    ws.onopen = () => console.log('Connected to Deriv WS');
    ws.onclose = () => console.log('Disconnected from Deriv WS');

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        // Handle tick updates
        if(data.tick) handleTick(data.tick);

        // Handle purchase response
        if(data.buy) handleTradeConfirmation(data.buy);
    };
}

/* ====== Subscribe to ticks ====== */
function subscribeTick(symbol) {
    ws.send(JSON.stringify({ticks:symbol}));
    tickSubscriptions[symbol] = null;
}

/* ====== Tick handler ====== */
function handleTick(tick) {
    tickSubscriptions[tick.symbol] = tick.quote;
    updateLivePricesUI();
}

/* ====== Update UI with live prices ====== */
function updateLivePricesUI() {
    const container = document.getElementById('freeBotsGrid');
    if(!container) return;
    container.innerHTML = '';
    Object.keys(tickSubscriptions).forEach(symbol => {
        const price = tickSubscriptions[symbol] ? tickSubscriptions[symbol].toFixed(2) : '-';
        const div = document.createElement('div');
        div.className = 'bot-card';
        div.innerHTML = `<h4>${symbol}</h4>
            <p>Price: ${price}</p>
            <button class="btn btn-primary" onclick="placeTrade('${symbol}','CALL')">Buy CALL</button>
            <button class="btn btn-primary" style="background:#ff5c5c" onclick="placeTrade('${symbol}','PUT')">Buy PUT</button>`;
        container.appendChild(div);
    });
}

/* ====== Place a demo trade ====== */
function placeTrade(symbol, direction) {
    // Simulate trade in front-end portfolio
    const lastPrice = tickSubscriptions[symbol];
    if(!lastPrice) return alert('Price not available yet');

    const stake = 10; // Fixed demo stake
    const trade = {
        symbol,
        direction,
        stake,
        entryPrice:lastPrice,
        timestamp:Date.now(),
        status:'open'
    };
    portfolio.trades.push(trade);

    // Mock buy request to Deriv (optional, you can uncomment to use real)
    /*
    ws.send(JSON.stringify({
        buy:{
            price: stake,
            symbol: symbol,
            contract_type: direction,
            basis:'stake',
            currency:'USD'
        }
    }));
    */

    updatePortfolioUI();
}

/* ====== Trade confirmation handler ====== */
function handleTradeConfirmation(buyResp){
    console.log('Trade confirmed:', buyResp);
}

/* ====== Portfolio UI ====== */
function updatePortfolioUI(){
    const dashboard = document.getElementById('dashboardSection');
    if(!dashboard) return;

    const tradesHTML = portfolio.trades.map(t=>{
        const now = Date.now();
        const elapsed = ((now-t.timestamp)/1000).toFixed(1);
        const pnl = t.direction==='CALL'? (tickSubscriptions[t.symbol]-t.entryPrice)*10 : (t.entryPrice-tickSubscriptions[t.symbol])*10;
        return <p>${t.symbol} ${t.direction} | Stake: $${t.stake} | PnL: $${pnl.toFixed(2)} | Open: ${elapsed}s ago</p>;
    }).join('');
    
    dashboard.querySelector('.card').innerHTML = `<h3>Portfolio Overview</h3>
        <div class="chart-box"><canvas id="portfolioChart"></canvas></div>
        <h4>Open Trades</h4>${tradesHTML}`;
    renderChart();
}

/* ====== Portfolio Chart ====== */
function renderChart(){
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    const labels = portfolio.trades.map(t=>t.symbol);
    const data = portfolio.trades.map(t=>{
        return t.direction==='CALL'? tickSubscriptions[t.symbol]-t.entryPrice : t.entryPrice-tickSubscriptions[t.symbol];
    });
    if(window.portfolioChart) window.portfolioChart.destroy();
    window.portfolioChart = new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[{label:'PnL',data, backgroundColor:'#7c5cff'}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}

/* ====== Init live trading ====== */
function initLiveTrading() {
    connectDeriv();
    activeSymbols.forEach(subscribeTick);
}

initLiveTrading();
</script>
</body>
</html>

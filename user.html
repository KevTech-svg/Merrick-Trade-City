<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merrick Trade City — User Panel</title>
<link rel="icon" type="image/png" href="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg">
<style>
/* --- Keep your full styles exactly as before --- */
@import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");
:root{--bg:#0c0f1f;--panel:#0a1025;--accent:#7c5cff;--accent2:#6a4bff;--accent2b:#b56cff;--muted:#bfbfcf;--glass:rgba(255,255,255,0.04);--radius:12px}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
html,body{height:100%}
body{display:flex;min-height:100vh;background:radial-gradient(circle at top,var(--bg),#05060d);color:#fff}
.loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(6,8,20,0.9),rgba(6,8,20,0.95));z-index:9999;flex-direction:column;transition:opacity .5s ease,visibility .5s ease}
.loading-hidden{opacity:0;visibility:hidden;pointer-events:none}
.brand-glow{font-size:36px;font-weight:800;letter-spacing:1px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent2b));-webkit-background-clip:text;background-clip:text;color:transparent;filter:drop-shadow(0 10px 40px rgba(108,78,255,0.12));animation:brandPulse 2.4s ease-in-out infinite;text-align:center}
@keyframes brandPulse{0%{filter:drop-shadow(0 6px 12px rgba(124,92,255,0.08))}50%{filter:drop-shadow(0 18px 50px rgba(124,92,255,0.25))}100%{filter:drop-shadow(0 6px 12px rgba(124,92,255,0.08))}}
.loading-sub{margin-top:12px;color:var(--muted);font-size:13px}
.sidebar{width:260px;padding:22px;background:linear-gradient(180deg,rgba(124,92,255,0.92),rgba(15,12,41,0.95));display:flex;flex-direction:column;justify-content:space-between;border-right:1px solid rgba(255,255,255,0.06)}
.sidebar h2{font-size:1.4rem;text-align:center;margin-bottom:14px;background:linear-gradient(90deg,#fff,#ccc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.profile-card{display:flex;gap:12px;align-items:center;background:var(--glass);padding:12px;border-radius:12px;backdrop-filter:blur(8px);margin-bottom:14px}
.profile-card img{width:64px;height:64px;border-radius:50%;border:2px solid var(--accent);cursor:pointer;object-fit:cover}
.profile-info small{color:var(--muted);display:block}
.menu{display:flex;flex-direction:column;gap:6px}
.menu button{background:none;border:none;color:#fff;text-align:left;padding:12px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .15s}
.menu button:hover{transform:translateX(6px);box-shadow:0 6px 18px rgba(124,92,255,0.12);background:rgba(255,255,255,0.03)}
.menu button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.sidebar .bottom-actions{display:flex;flex-direction:column;gap:10px;margin-top:14px}
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.main{flex:1;padding:18px;display:flex;flex-direction:column;gap:16px;overflow:auto}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,12,0.5)}
footer{margin-top:10px;text-align:center;color:var(--muted)}
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay"><div class="brand-glow">Merrick Trade City</div><div class="loading-sub">Connecting… please wait</div></div>

<!-- Minimal structure preserved for brevity (your full original HTML continues here) -->
<!-- ... (keep everything else from your original code unchanged) ... -->

<script>
/* ====== OAuth fix & WebSocket handling ====== */
const DERIV_APP_ID = '109286';
const REDIRECT_URI = location.origin + '/Merrick-Trade-City/user.html';
let derivToken = null;
let ws = null;

/* --- Extract OAuth token only once --- */
function grabTokenFromUrl(){
  const hash = window.location.hash || '';
  let token = null;
  if(hash.includes('access_token')){
    const params = new URLSearchParams(hash.replace('#','?'));
    token = params.get('access_token');
    if(token){
      localStorage.setItem('deriv_token', token);
      history.replaceState(null,'',window.location.pathname);
    }
  }
  return token;
}

/* --- Connect WebSocket safely --- */
function connectDerivWS(){
  derivToken = derivToken || localStorage.getItem('deriv_token');
  if(!derivToken) return;
  if(ws && ws.readyState === WebSocket.OPEN) return;

  ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id='+DERIV_APP_ID);
  ws.onopen = ()=> ws.send(JSON.stringify({authorize: derivToken}));
  ws.onmessage = e=>{
    const data = JSON.parse(e.data);
    if(data.error && data.error.code === 'InvalidToken'){
      localStorage.removeItem('deriv_token');
      alert('Session expired. Please log in again.');
      location.href='index.html';
    }
  };
}

/* --- Init --- */
window.onload = ()=>{
  const loading = document.getElementById('loadingOverlay');
  const token = grabTokenFromUrl();
  if(token){
    derivToken = token;
    connectDerivWS();
  } else {
    const stored = localStorage.getItem('deriv_token');
    if(stored){
      derivToken = stored;
      connectDerivWS();
    } else {
      // only redirect if no token at all
      setTimeout(()=>{
        window.location.href = 'https://oauth.deriv.com/oauth2/authorize?app_id='+DERIV_APP_ID+'&redirect_uri='+encodeURIComponent(REDIRECT_URI)+'&response_type=token';
      },1500);
    }
  }
  setTimeout(()=>loading.classList.add('loading-hidden'),2000);
};
</script>
</body>
</html>

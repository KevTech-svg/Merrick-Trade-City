<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merrick Trade City — User Panel</title>
<link rel="icon" type="image/png" href="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");
  :root{--bg:#0c0f1f;--panel:#0a1025;--accent:#7c5cff;--accent2:#6a4bff;--muted:#bfbfcf}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{display:flex;min-height:100vh;background:radial-gradient(circle at top,var(--bg),#05060d);color:#fff}

  /* Loading overlay */
  .loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(6,8,20,0.9), rgba(6,8,20,0.95));z-index:9999;flex-direction:column;transition:opacity .5s ease, visibility .5s ease}
  .loading-hidden{opacity:0;visibility:hidden;pointer-events:none}
  .brand-glow{font-size:28px;font-weight:800;letter-spacing:1px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;color:transparent}
  .loading-sub{margin-top:12px;color:var(--muted);font-size:13px}

  /* Layout */
  .sidebar{width:260px;padding:18px;background:linear-gradient(180deg, rgba(124,92,255,0.92), rgba(15,12,41,0.95));display:flex;flex-direction:column;justify-content:space-between;border-right:1px solid rgba(255,255,255,0.06)}
  .profile-card{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,0.03);padding:12px;border-radius:12px}
  .profile-card img{width:64px;height:64px;border-radius:50%;object-fit:cover;cursor:pointer}
  .menu{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .menu button{background:none;border:none;color:#fff;padding:10px;border-radius:10px;text-align:left;cursor:pointer;font-weight:600;transition:all .15s}
  .menu button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}

  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}

  .main{flex:1;padding:18px;display:flex;flex-direction:column;gap:16px;overflow:auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px}
  .logo-small{width:44px;height:44px;border-radius:10px;object-fit:cover}
  .small-muted{color:var(--muted);font-size:13px}

  .bots-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
  .bot-card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;text-align:center}
  .chart-box{height:360px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}

  .input{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  .muted{color:var(--muted);font-size:13px}

  footer{margin-top:10px;text-align:center;color:var(--muted)}

  /* Responsive adjustments */
  @media (max-width:980px){
    body{flex-direction:column}
    .sidebar{width:100%;flex-direction:row;gap:12px;padding:10px;align-items:center}
    .menu{flex-direction:row;overflow:auto}
    .chart-box{height:260px}
    .profile-card img{width:48px;height:48px}
  }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay" role="status" aria-live="polite">
  <div class="brand-glow">Merrick Trade City</div>
  <div class="loading-sub" id="loadingSub">Connecting… please wait</div>
</div>

<!-- Sidebar -->
<div class="sidebar" role="navigation" aria-label="Main sidebar">
  <div>
    <h2 style="margin:0 0 8px 0">User Panel</h2>

    <!-- Inline SVG avatar avoids 404 -->
    <div class="profile-card card" style="margin-bottom:8px">
      <img id="profilePic" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' fill='%237c5cff'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Poppins,Arial' font-size='56' fill='white'>M</text></svg>" alt="User avatar" onclick="onChangeProfilePic()" title="Change profile picture">
      <div>
        <div id="userName">Loading…</div>
        <small id="userBalance">Balance: —</small><br>
        <small id="userEmail">—</small>
      </div>
    </div>

    <div class="menu" id="menu">
      <button data-section="dashboard" class="active">Dashboard</button>
      <button data-section="freebots">Free Bots</button>
      <button data-section="dtrader">D-Trader</button>
      <button data-section="smart">Smart Analysis</button>
      <button data-section="analysis">Analysis Tool</button>
      <button data-section="signals">Signals</button>
      <button data-section="charts">Charts</button>
      <button data-section="copy">Copy Trading</button>
    </div>
  </div>

  <div style="margin-top:12px">
    <div style="margin-bottom:8px">
      <button class="btn btn-primary" id="githubStatusBtn">GitHub: auto</button>
    </div>
    <button class="btn" onclick="openTokenModal()">Deriv Token</button>
    <button class="btn" onclick="promptLogin()">Switch User</button>
  </div>
</div>

<!-- Main -->
<div class="main" role="main">
  <div class="welcome card" style="display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg" class="logo-small" alt="Merrick logo">
      <div>
        <div style="font-weight:700">Welcome back, <span id="displayName">User</span></div>
        <div class="small-muted">Trade live with your Deriv account inside Merrick Trade City</div>
      </div>
    </div>

    <div style="text-align:right;min-width:260px">
      <div style="margin-bottom:8px">
        <small class="muted">Loaded bot: <strong id="loadedBot">None</strong></small>
      </div>

      <!-- Quick Deriv controls: connect, get balance, choose symbol -->
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-ghost" id="connectDerivBtn">Connect Deriv</button>
        <button class="btn btn-primary" id="getBalanceBtn">Get Balance</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <select id="symbolSelect" class="input" style="width:140px">
          <option value="R_100">R_100</option>
          <option value="R_50">R_50</option>
          <option value="FRXUSDJPY">USD/JPY</option>
          <option value="R_10">R_10</option>
          <option value="XAUSD">XAUUSD</option>
        </select>
        <button class="btn btn-ghost" id="subTicksBtn">Subscribe Ticks</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <section id="dashboardSection" class="card">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <small class="small-muted">Quick Tutorial</small>
        <h3 style="margin:8px 0">How to add & run bots</h3>
        <div style="aspect-ratio:16/9;border-radius:10px;overflow:hidden;margin-top:8px">
          <iframe id="ytTutorial" src="https://www.youtube.com/embed/yup6kew1BBU?si=yNLIy1Fym8RjD9HI" style="width:100%;height:100%;border:0" allowfullscreen></iframe>
        </div>
        <div style="margin-top:8px" class="small-muted">Replace this YouTube link any time.</div>
      </div>

      <div style="width:360px">
        <small class="small-muted">Live Ticks & Trading</small>
        <div class="card" style="margin-top:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <div>Symbol:</div>
            <div id="liveSymbol" class="muted">—</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <div>Last Price:</div>
            <div id="lastTick" style="font-weight:700">—</div>
          </div>

          <hr style="margin:10px 0;border-color:rgba(255,255,255,0.04)">

          <div>
            <label class="muted">Amount (stake)</label>
            <input id="tradeAmount" class="input" placeholder="Amount (e.g., 1)" value="1">
            <label class="muted" style="margin-top:8px">Duration (seconds)</label>
            <input id="tradeDuration" class="input" placeholder="Duration in seconds" value="60" type="number">
            <label class="muted" style="margin-top:8px">Direction</label>
            <select id="tradeDirection" class="input">
              <option value="CALL">Rise / CALL</option>
              <option value="PUT">Fall / PUT</option>
            </select>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn btn-ghost" id="proposalBtn">Request Proposal</button>
              <button class="btn btn-primary" id="buyBtn">Buy Proposal</button>
            </div>
            <div id="proposalInfo" class="muted" style="margin-top:8px">No proposal requested.</div>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <h3>Available Bots</h3>
      <div class="bots-grid" id="botsContainer"></div>
    </div>

    <div style="margin-top:14px">
      <h3>Your Portfolio</h3>
      <div class="chart-box"><canvas id="portfolioChart" style="width:100%;height:100%"></canvas></div>
    </div>
  </section>

  <!-- sections kept for navigation; initially hidden -->
  <section id="freebotsSection" style="display:none" class="card"><h3>Shared Bots</h3><div id="sharedBotsContainer" class="bots-grid"></div></section>
  <section id="dtraderSection" style="display:none" class="card"><h3>D-Trader (TradingView)</h3><div id="tvFrameWrap" class="chart-box"></div></section>
  <section id="chartsSection" style="display:none" class="card"><h3>Charts</h3><div id="tvChartWrap" class="chart-box"></div></section>
  <section id="smartSection" style="display:none" class="card"><h3>Smart Analysis</h3></section>
  <section id="analysisSection" style="display:none" class="card"><h3>Analysis Tool</h3></section>
  <section id="signalsSection" style="display:none" class="card"><h3>Signals</h3></section>
  <section id="copySection" style="display:none" class="card"><h3>Copy Trading</h3></section>

  <footer><small class="small-muted">© 2025 Merrick Trade City — All rights reserved.</small></footer>
</div>

<!-- Deriv Token Modal -->
<div class="modal" id="tokenModal">
  <div class="modal-content">
    <h3>Deriv Token / OAuth</h3>
    <p class="muted">Paste a Deriv API token (starts with <code>1|</code>) for client-side live trading, or use OAuth redirect from Deriv.</p>
    <input id="manualDerivToken" class="input" placeholder="1|..." />
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn" onclick="closeTokenModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveDerivToken()">Save Token</button>
    </div>
  </div>
</div>

<script>
/* ========== Config ========== */
const GITHUB_OWNER = 'KevTech-svg';
const GITHUB_REPO  = 'merrick-data'; // your repo
const USERS_PATH   = 'users.json';
const ADMIN_BOTS_PATH = 'admin_bots.json';

const DERIV_APP_ID = '109286'; // you gave this
const REDIRECT_URI = location.origin + '/Merrick-Trade-City/user.html';

/* ========== Runtime state ========== */
let githubToken = localStorage.getItem('merrick_github_token') || null;
let usersData = {};          // { email: {...} }
let adminBots = [];          // array of {name,...}
let currentUserEmail = localStorage.getItem('merrick_current_user') || null;
let currentUser = null;
let portfolioChart = null;
let pollingInterval = null;

/* Deriv ws */
let derivWS = null;
let lastProposal = null; // hold latest proposal response

/* ========== Small helpers ========== */
function qs(sel){ return document.querySelector(sel); }
function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function openModal(id){ const m = qs('#'+id); if(m) m.style.display='flex'; }
function closeModal(id){ const m = qs('#'+id); if(m) m.style.display='none'; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ========== Menu wiring ========== */
qsa('.menu button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    qsa('.menu button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const section = btn.dataset.section;
    const map = {
      dashboard: 'dashboardSection',
      freebots: 'freebotsSection',
      dtrader: 'dtraderSection',
      smart: 'smartSection',
      analysis: 'analysisSection',
      signals: 'signalsSection',
      charts: 'chartsSection',
      copy: 'copySection'
    };
    Object.values(map).forEach(id => { const el = qs('#'+id); if(el) el.style.display = 'none'; });
    const showId = map[section];
    if(showId){ const el = qs('#'+showId); if(el) el.style.display = 'block'; }
  });
});

/* ========== GitHub helpers (read admin bots + optionally users) ========== */
function githubApiHeaders(){
  const headers = { 'Accept': 'application/vnd.github.v3+json' };
  if(githubToken) headers['Authorization'] = 'token ' + githubToken;
  return headers;
}
async function fetchGitHubFile(path){
const url = https://api.github.com/repos/KevTech-svg/Merrick-Trade-City/contents/admin-bots.json?ref=main;
  const res = await fetch(url, { headers: githubApiHeaders() });
  if(res.status === 404) return null;
  if(!res.ok) throw new Error('GitHub fetch error: ' + res.status);
  return await res.json();
}
async function getJsonFromGitHub(path){
  const file = await fetchGitHubFile(path);
  if(!file) return null;
  const text = atob(file.content.replace(/\n/g,''));
  try { return JSON.parse(text); } catch(e){ console.warn('Invalid JSON in', path); return null; }
}
/* read-only fallback for admin bots - loads raw */
async function loadAdminBotsFromGitHubReadOnly(){
  try{
    const url = https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${ADMIN_BOTS_PATH};
    const res = await fetch(url);
    if(res.ok){
      adminBots = await res.json();
    } else {
      adminBots = [{ name:'Admin Bot 1' }, { name:'Admin Bot 2' }];
    }
  } catch(e){
    adminBots = [{ name:'Admin Bot 1' }, { name:'Admin Bot 2' }];
  }
}
async function loadAllDataFromGitHub(){
  try{
    const users = await getJsonFromGitHub(USERS_PATH);
    if(users) usersData = users;
    const admin = await getJsonFromGitHub(ADMIN_BOTS_PATH);
    if(admin) adminBots = admin;
  } catch(e){
    console.warn('loadAllDataFromGitHub error', e);
  }
}

/* ========== User management ========== */
function setCurrentUser(email, fallback){
  currentUserEmail = email;
  localStorage.setItem('merrick_current_user', email);
  if(!usersData[email] && fallback) usersData[email] = fallback;
  currentUser = usersData[email];
  if(!currentUser){
    usersData[email] = { name: email.split('@')[0], email, balance: 0, bots: [], avatar: '' };
    currentUser = usersData[email];
  }
  qs('#userName').textContent = currentUser.name || currentUser.email;
  qs('#displayName').textContent = currentUser.name || currentUser.email;
  qs('#userBalance').textContent = 'Balance: ' + (currentUser.balance !== undefined ? currentUser.balance : 0);
  qs('#userEmail').textContent = currentUser.email;
  if(currentUser.avatar) qs('#profilePic').src = currentUser.avatar;
  buildBotsUI();
  setupPortfolioChart();
}
async function promptLogin(){
  const email = prompt('Enter your email to sign in:');
  if(!email) return;
  if(!usersData[email]) {
    usersData[email] = { name: email.split('@')[0], email, balance: 0, bots: [], avatar: '' };
    // optionally save to GitHub if token available (not automatic here)
  }
  setCurrentUser(email);
}

/* ========== Bots UI ========== */
function buildBotsUI(){
  const container = qs('#botsContainer'); if(!container) return; container.innerHTML = '';
  if(currentUser && Array.isArray(currentUser.bots)){
    currentUser.bots.forEach((bot, idx)=>{
      const d = document.createElement('div'); d.className = 'bot-card';
      d.innerHTML = `<h4>${escapeHtml(bot.name)}</h4><div class="muted">Your Bot</div>
        <div style="margin-top:8px"><button class="btn btn-primary" onclick="alert('Run: ${escapeHtml(bot.name)}')">Run</button>
        <button class="btn btn-ghost" onclick="removeUserBot(${idx})">Remove</button></div>`;
      container.appendChild(d);
    });
  }
  // admin/shared bots
  const sharedContainer = qs('#sharedBotsContainer'); if(!sharedContainer) sharedContainer.innerHTML = '';
  adminBots.forEach(bot=>{
    const d = document.createElement('div'); d.className = 'bot-card';
    d.innerHTML = <h4>${escapeHtml(bot.name)}</h4><div class="muted">Shared</div><div style="margin-top:8px"><button class="btn" onclick="loadSharedBot('${escapeHtml(bot.name)}')">Load</button></div>;
    container.appendChild(d);
    if(sharedContainer) sharedContainer.insertAdjacentHTML('beforeend', <div class="bot-card"><h4>${escapeHtml(bot.name)}</h4></div>);
  });
}
function removeUserBot(idx){ if(!confirm('Remove this bot?')) return; currentUser.bots.splice(idx,1); usersData[currentUser.email] = currentUser; buildBotsUI(); }
function loadSharedBot(name){ qs('#loadedBot').textContent = name; alert('Loaded shared bot: ' + name); }

/* ========== Portfolio chart ========== */
let portfolioChart = null;
function setupPortfolioChart(){
  const el = qs('#portfolioChart'); if(!el) return;
  const ctx = el.getContext('2d');
  if(portfolioChart) portfolioChart.destroy();
  const labels = generatePastDaysLabels(7);
  const balances = generateDemoBalances(labels.length, currentUser ? currentUser.balance : 0);
  portfolioChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Balance (Ksh)', data: balances }] },
    options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
  });
}
function generatePastDaysLabels(n){
  const out=[]; for(let i=n-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); out.push(${d.getMonth()+1}/${d.getDate()}); } return out;
}
function generateDemoBalances(n, latest){
  if(!latest && latest !== 0) latest = Math.floor(Math.random()*1000)+100;
  const arr = []; for(let i=0;i<n;i++){ arr.push(Math.max(0, Math.floor(latest - (n-i-1)*Math.random()*200))); } return arr;
}

/* ========== Polling for live updates (GitHub) ========== */
async function startPolling(){
  if(pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(async ()=>{
    try{
      if(githubToken){
        await loadAllDataFromGitHub();
        if(currentUserEmail && usersData[currentUserEmail]) setCurrentUser(currentUserEmail);
        buildBotsUI();
        if(portfolioChart && currentUser && currentUser.balance !== undefined){
          const last = portfolioChart.data.datasets[0].data;
          last[last.length - 1] = currentUser.balance;
          portfolioChart.update();
        }
      } else {
        // nothing to poll without token
      }
    } catch(e){ console.warn('poll error', e); }
  }, 10000);
}

/* ========== GitHub modal logic ========== */
function openGithubModal(){ openModal('githubModal'); }
function closeGithubModal(){ closeModal('githubModal'); }
function saveGithubToken(){ const t = qs('#githubTokenInput')?.value?.trim(); if(!t) return alert('Paste a GitHub token first'); githubToken = t; localStorage.setItem('merrick_github_token', t); closeGithubModal(); loadAllDataFromGitHub().then(()=>{ alert('Connected to GitHub (read/write).'); buildBotsUI(); }).catch(err=>{ alert('Failed: '+err.message); }); }
qs('#githubStatusBtn')?.addEventListener('click', ()=> { if(!githubToken) openGithubModal(); else alert('GitHub token set (auto).'); });

/* ========== Deriv WebSocket - Connect / Authorize / Balance / Ticks / Buy ========== */
/* Basic flow:
   - connectDerivWS() opens connection and authorizes (with token from localStorage)
   - when authorized, we request balance.
   - subscribeTicks(symbol) subscribes to live ticks and updates UI.
   - requestProposal() sends a 'proposal' request (basic params).
   - buyProposal() purchases the last proposal (if present).
   Notes: This is a minimal in-browser implementation. For production move tokens & buy ops server-side.
*/
function connectDerivWS(){
  const token = localStorage.getItem('deriv_token');
  if(!token) { alert('No Deriv token found. Add one via "Deriv Token" button.'); return; }

  const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=' + encodeURIComponent(DERIV_APP_ID);
  if(derivWS){ try{ derivWS.close(); }catch(e){} derivWS = null; }

  derivWS = new WebSocket(wsUrl);
  derivWS.onopen = () => {
    console.log('Deriv WS open — sending authorize');
    derivWS.send(JSON.stringify({ authorize: token }));
  };
  derivWS.onmessage = (evt) => {
    try{
      const data = JSON.parse(evt.data);
      // handle different messages
      if(data.msg_type === 'authorize'){
        console.log('Authorized:', data.authorize);
        if(data.authorize && data.authorize.email) {
          // switch to that user if exists
          if(usersData[data.authorize.email]) setCurrentUser(data.authorize.email);
        }
        qs('#githubStatusBtn').textContent = 'Deriv: authorized';
        // request balance
        requestDerivBalance();
      }
      if(data.msg_type === 'balance'){
        const b = Array.isArray(data.balance) ? data.balance[0] : data.balance;
        if(b && currentUser){
          currentUser.balance = b.balance;
          qs('#userBalance').textContent = 'Balance: ' + b.balance + (b.currency ? ' ' + b.currency : '');
          // optionally persist to GitHub if you want (requires token)
        }
      }
      if(data.msg_type === 'tick'){
        // tick: { tick: {symbol, quote, epoch} }
        const t = data.tick;
        qs('#lastTick').textContent = t.quote;
        qs('#liveSymbol').textContent = t.symbol;
      }
      if(data.msg_type === 'proposal'){
        // proposal object -> store it
        lastProposal = data.proposal;
        qs('#proposalInfo').textContent = Proposal ask: ${lastProposal.ask_price} | id: ${lastProposal.id};
      }
      if(data.msg_type === 'buy'){
        // buy response -> contract info
        qs('#proposalInfo').textContent = Bought contract id: ${data.buy.contract_id} — status: ${data.buy.contract_type || 'N/A'};
        console.log('buy result', data.buy);
      }
    }catch(err){ console.warn('Deriv parse error', err); }
  };
  derivWS.onerror = (e) => { console.error('Deriv WS error', e); alert('Deriv WS error (check console).'); };
  derivWS.onclose = () => { console.warn('Deriv WS closed'); qs('#githubStatusBtn').textContent = 'Deriv: disconnected'; };
}

/* Request balance */
function requestDerivBalance(){ if(!derivWS || derivWS.readyState !== WebSocket.OPEN) return; derivWS.send(JSON.stringify({ balance: 1 })); }

/* Subscribe to ticks for a symbol (live price updates) */
function subscribeTicks(symbol){
  if(!derivWS || derivWS.readyState !== WebSocket.OPEN) return alert('Connect to Deriv first.');
  // unsubscribe previous ticks (forget all tick subscriptions)
  // (for simplicity we don't track subscription ids; this is a minimal approach)
  derivWS.send(JSON.stringify({ forget: 'ticks' })); // best-effort (ignore failure)
  derivWS.send(JSON.stringify({ ticks: symbol }));
}

/* Request a proposal — minimal parameters for short binary contract */
function requestProposal(){
  if(!derivWS || derivWS.readyState !== WebSocket.OPEN) return alert('Connect to Deriv first.');
  const symbol = qs('#symbolSelect').value;
  const amount = qs('#tradeAmount').value || '1';
  const duration = Number(qs('#tradeDuration').value || 60);
  const direction = qs('#tradeDirection').value; // CALL / PUT
  // Basic proposal payload — note: many contract types exist; this uses simple rise/fall contract
  const payload = {
    proposal: 1,
    amount: String(amount),
    basis: 'stake',
    contract_type: direction === 'CALL' ? 'CALL' : 'PUT',
    currency: 'USD',
    duration: duration,
    duration_unit: 's',
    symbol
  };
  // send proposal
  derivWS.send(JSON.stringify(payload));
  qs('#proposalInfo').textContent = 'Requesting proposal...';
}

/* Buy latest proposal (if any) */
function buyProposal(){
  if(!derivWS || derivWS.readyState !== WebSocket.OPEN) return alert('Connect to Deriv first.');
  if(!lastProposal || !lastProposal.id) return alert('No proposal available. Request a proposal first.');
  // buy expects { buy: proposal_id, price: ask_price }
  const buyPayload = {
    buy: lastProposal.id,
    price: lastProposal.ask_price
  };
  derivWS.send(JSON.stringify(buyPayload));
  qs('#proposalInfo').textContent = 'Buying...';
}

/* ========== UI wiring for Deriv controls ========== */
qs('#connectDerivBtn').addEventListener('click', ()=>{
  // if token present in localStorage -> connect; else prompt user to add one
  const t = localStorage.getItem('deriv_token');
  if(!t){
    openModal('tokenModal');
    return;
  }
  connectDerivWS();
});
qs('#getBalanceBtn').addEventListener('click', ()=> requestDerivBalance());
qs('#subTicksBtn').addEventListener('click', ()=> subscribeTicks(qs('#symbolSelect').value));
qs('#proposalBtn').addEventListener('click', ()=> requestProposal());
qs('#buyBtn').addEventListener('click', ()=> buyProposal());

/* Token modal actions */
function openTokenModal(){ openModal('tokenModal'); }
function closeTokenModal(){ closeModal('tokenModal'); }
function saveDerivToken(){
  const t = qs('#manualDerivToken').value?.trim();
  if(!t) return alert('Paste a Deriv token (starts with 1|...)');
  localStorage.setItem('deriv_token', t);
  closeTokenModal();
  alert('Deriv token saved to localStorage. Click "Connect Deriv" to authorize.');
}

/* Parse token from OAuth redirect (if Deriv redirected back with #access_token=... ) */
function grabDerivTokenFromUrl(){
  const hash = window.location.hash || '';
  if(!hash) return null;
  const params = new URLSearchParams(hash.replace('#','?'));
  const token = params.get('access_token');
  if(token){
    localStorage.setItem('deriv_token', token);
    try{ history.replaceState(null,'',window.location.pathname+window.location.search); }catch(e){}
    return token;
  }
  return null;
}

/* ========== TradingView embed helpers (keeps layout consistent) ========== */
function embedTradingView(targetId, symbol='OANDA:XAUUSD'){
  const w = qs('#' + targetId);
  if(!w) return;
  const frame = document.createElement('iframe');
  frame.style.width = '100%';
  frame.style.height = '100%';
  frame.style.border = 0;
  frame.src = 'https://s.tradingview.com/widgetembed/?frameElementId=' + encodeURIComponent(targetId) + '&symbol=' + encodeURIComponent(symbol) + '&interval=60&hidesidetoolbar=1&theme=dark';
  w.innerHTML = '';
  w.appendChild(frame);
}
embedTradingView('tvFrameWrap', 'OANDA:XAUUSD');
embedTradingView('tvChartWrap', 'OANDA:XAUUSD');

/* ========== Initialization ========== */
async function init(){
  try{
    // If GitHub token stored, auto attempt to load (silent)
    if(githubToken){
      try{ await loadAllDataFromGitHub(); } catch(e){ console.warn('auto load GH failed', e); await loadAdminBotsFromGitHubReadOnly(); }
    } else {
      // try to load shared bots from public repo raw automatically (no UI text)
      await loadAdminBotsFromGitHubReadOnly();
    }

    // restore current user or create demo
    if(currentUserEmail && usersData[currentUserEmail]) setCurrentUser(currentUserEmail);
    else setCurrentUser('demo@example.com', { name:'Demo User', email:'demo@example.com', balance:1200, bots:[], avatar:'' });

    buildBotsUI();
    setupPortfolioChart();
    startPolling();

    // If Deriv OAuth redirected back with token, grab it
    const maybeDeriv = grabDerivTokenFromUrl();
    if(maybeDeriv){
      connectDerivWS();
    }
  } catch(err){
    console.error('init error', err);
  } finally {
    qs('#loadingOverlay').classList.add('loading-hidden');
    setTimeout(()=> { qs('#loadingOverlay').style.display='none'; }, 600);
  }
}
window.addEventListener('load', init);
</script>
</body>
</html>


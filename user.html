<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Merrick Trade City — User Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{--accent:#7c5cff;--muted:#bfbfcf}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:radial-gradient(circle at top,#0c0f1f,#05060d);color:#fff;display:flex;min-height:100vh}
    .sidebar{width:260px;padding:20px;background:linear-gradient(180deg,rgba(124,92,255,0.92),rgba(15,12,41,0.95));display:flex;flex-direction:column;gap:12px}
    .main{flex:1;padding:18px;overflow:auto}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#6a4bff);color:#fff}
    .small-muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>User Panel</h2>
    <div class="card">
      <div style="display:flex;gap:12px;align-items:center">
        <img id="profilePic" src="assets/default-avatar.png" alt="avatar" style="width:64px;height:64px;border-radius:50%;border:2px solid var(--accent);object-fit:cover">
        <div>
          <div id="displayName">Kelvin</div>
          <small id="userEmail" class="small-muted">—</small>
          <small id="userBalance" class="small-muted">Balance: —</small>
        </div>
      </div>
    </div>

    <div style="margin-top:auto">
      <button class="btn btn-primary" id="connectDerivBtn">Connect / Reconnect to Deriv</button>
      <button class="btn" id="logoutUserBtn" style="margin-top:8px">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Welcome back, <span id="welcomeName">Trader</span></strong><div class="small-muted">Trade live with Deriv</div></div>
      <div><small class="small-muted">Loaded bot: <strong id="loadedBot">None</strong></small></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Trade Controls</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <select id="marketSelect" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:none;color:#fff">
          <option value="OANDA:XAUUSD">XAUUSD (Gold)</option>
          <option value="OANDA:EUR_USD">EURUSD</option>
          <option value="SYNTHETIC:103">Volatility 100</option>
          <option value="BINANCE:BTCUSDT">BTCUSD</option>
        </select>
        <input id="stake" placeholder="Stake (USD)" value="1" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:none;color:#fff">
        <input id="duration" placeholder="Duration (s)" value="5" style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);border:none;color:#fff">
        <button class="btn btn-primary" id="callBtn">CALL</button>
        <button class="btn btn-ghost" id="putBtn">PUT</button>
      </div>
      <div id="derivInfo" class="small-muted" style="margin-top:10px">Not connected</div>
    </div>
  </div>

<script>
/* Deriv settings */
const DERIV_APP_ID = '109286';
const REDIRECT_URI = location.origin + '/user.html';
const DERIV_TOKEN_KEY = 'deriv_token';

/* Helpers */
function $(sel){ return document.querySelector(sel); }
function showInfo(t){ $('#derivInfo').textContent = t; }

/* Parse token from URL (OAuth returns in hash) */
function grabTokenFromUrl(){
  const hash = window.location.hash || '';
  if(!hash) return null;
  const params = new URLSearchParams(hash.replace('#','?'));
  const token = params.get('access_token') || params.get('accessToken') || null;
  if(token){
    localStorage.setItem(DERIV_TOKEN_KEY, token);
    // clean url
    history.replaceState(null,'', location.pathname + location.search);
  }
  return token;
}

/* Open Deriv OAuth */
function connectDeriv(){
  const oauthUrl = 'https://oauth.deriv.com/oauth2/authorize?app_id=' + encodeURIComponent(DERIV_APP_ID) +
                   '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) + '&response_type=token';
  location.href = oauthUrl;
}

/* WebSocket handling (BinaryWS) */
let ws = null;
function connectWS(){
  const tok = localStorage.getItem(DERIV_TOKEN_KEY);
  if(!tok){ showInfo('No Deriv token. Click Connect.'); return; }
  showInfo('Connecting...');
  const wsUrl = 'wss://ws.binaryws.com/websockets/v3?app_id=' + encodeURIComponent(DERIV_APP_ID);

  if(ws) try{ ws.close(); }catch(e){}
  ws = new WebSocket(wsUrl);

  ws.onopen = ()=> {
    // authorize with token
    ws.send(JSON.stringify({authorize: tok}));
    showInfo('Authorizing...');
  };
  ws.onmessage = (evt)=>{
    try{
      const d = JSON.parse(evt.data);
      if(d.authorize){
        const auth = d.authorize;
        showInfo('Connected as ' + (auth.loginid || 'user'));
        if(auth.display_name) $('#welcomeName').textContent = auth.display_name;
        if(auth.email) $('#userEmail').textContent = auth.email;
        // request balance
        requestBalance();
      }
      if(d.balance){
        if(Array.isArray(d.balance) && d.balance[0]){
          const b = d.balance[0];
          $('#userBalance').textContent = 'Balance: ' + b.balance + (b.currency ? ' ' + b.currency : '');
        } else if(d.balance && d.balance.balance !== undefined){
          $('#userBalance').textContent = 'Balance: ' + d.balance.balance + (d.balance.currency ? ' ' + d.balance.currency : '');
        }
      }
      if(d.error) console.warn('Deriv error', d.error);
      if(d.buy) console.log('Buy response', d.buy);
    }catch(e){ console.warn(e); }
  };
  ws.onerror = (e)=> showInfo('WS error');
  ws.onclose = ()=> showInfo('Disconnected');
}

/* Request balance */
function requestBalance(){
  if(!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({balance:1}));
}

/* Proposal / buy */
function requestProposal(symbol, amount, duration, contractType){
  return new Promise((resolve,reject)=>{
    if(!ws || ws.readyState !== WebSocket.OPEN) return reject(new Error('WS not open'));
    const id = 'p_' + Date.now();
    const payload = { proposal:1, amount, basis:'stake', contract_type:contractType, symbol, duration, duration_unit:'s', id };
    function handler(evt){
      const d = JSON.parse(evt.data);
      if(d.proposal && d.echo_req && d.echo_req.id === id){ ws.removeEventListener('message', handler); return resolve(d.proposal); }
      if(d.error && d.echo_req && d.echo_req.id === id){ ws.removeEventListener('message', handler); return reject(new Error(d.error.message || 'proposal error')); }
    }
    ws.addEventListener('message', handler);
    ws.send(JSON.stringify(payload));
    setTimeout(()=>{ ws.removeEventListener('message', handler); reject(new Error('proposal timeout')); }, 8000);
  });
}
function buyProposal(proposal){
  return new Promise((resolve,reject)=>{
    if(!ws || ws.readyState !== WebSocket.OPEN) return reject(new Error('WS not open'));
    function onmsg(evt){
      const d = JSON.parse(evt.data);
      if(d.buy){ ws.removeEventListener('message', onmsg); return resolve(d.buy); }
      if(d.error){ ws.removeEventListener('message', onmsg); return reject(new Error(d.error.message || 'buy error')); }
    }
    ws.addEventListener('message', onmsg);
    ws.send(JSON.stringify({ buy: proposal.id }));
    setTimeout(()=>{ ws.removeEventListener('message', onmsg); reject(new Error('buy timeout')); }, 10000);
  });
}

async function place(direction){
  const symbol = $('#marketSelect').value;
  const stake = Number($('#stake').value) || 1;
  const duration = Number($('#duration').value) || 5;
  const contractType = direction === 'CALL' ? 'CALL' : 'PUT';

  const tok = localStorage.getItem(DERIV_TOKEN_KEY);
  if(!tok){ alert('Not connected to Deriv. Click Connect.'); return; }
  if(!ws || ws.readyState !== WebSocket.OPEN){ alert('WebSocket not open. Reconnect.'); return; }

  try{
    const proposal = await requestProposal(symbol, stake, duration, contractType);
    if(!proposal) throw new Error('No proposal');
    const res = await buyProposal(proposal);
    console.log('Trade placed', res);
    alert('Trade placed (response received).');
  }catch(err){ alert('Trade failed: ' + (err.message || err)); console.error(err); }
}

/* UI wiring */
document.getElementById('connectDerivBtn').addEventListener('click', connectDeriv);
document.getElementById('callBtn').addEventListener('click', ()=> place('CALL'));
document.getElementById('putBtn').addEventListener('click', ()=> place('PUT'));
document.getElementById('logoutUserBtn').addEventListener('click', ()=>{
  localStorage.removeItem(DERIV_TOKEN_KEY);
  alert('Logged out (Deriv token removed).');
  showInfo('Not connected');
});

/* On load: parse token and connect if present */
window.addEventListener('load', ()=>{
  const parsed = grabTokenFromUrl();
  const token = parsed || localStorage.getItem(DERIV_TOKEN_KEY);
  if(token) connectWS();
  else showInfo('Not connected. Click Connect to sign in with Deriv.');
});
</script>
</body>
</html>

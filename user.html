<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merrick Trade City — User Panel</title>
<link rel="icon" type="image/png" href="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg" />

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: Poppins, sans-serif; }
  body { background: #0d1117; color: #eee; min-height: 100vh; display: flex; flex-direction: column; }
  header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #161b22; }
  header img { height: 40px; border-radius: 8px; }
  header h1 { font-size: 1.2rem; }
  #main { flex: 1; display: flex; }
  #sidebar { width: 220px; background: #161b22; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  #sidebar button { background: #21262d; color: #eee; border: none; padding: 10px; border-radius: 8px; cursor: pointer; text-align: left; }
  #sidebar button:hover { background: #30363d; }
  #content { flex: 1; padding: 15px; overflow-y: auto; }
  .section { display: none; }
  .active-section { display: block; }

  .bot-card { background: #21262d; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
  .muted { color: #aaa; font-size: 0.8rem; }

  .btn { background: #238636; color: #fff; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
  .btn:hover { background: #2ea043; }

  canvas { width: 100% !important; height: 300px !important; }

  #tvFrameWrap, #tvChartWrap { height: 400px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
  #loadingOverlay {
    position: fixed; inset: 0; background: #0d1117; z-index: 99;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .loading-hidden { display: none !important; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <img src="A_logo_for_Merrick_Trade_City_is_displayed_against.png.jpg" alt="Merrick Logo">
    <h1>Merrick Trade City — User Panel</h1>
  </div>
  <div id="userInfo">
    <span id="userName">Loading...</span>
    <img id="profilePic" src="https://i.imgur.com/8Km9tLL.png" alt="Profile" style="height:40px;width:40px;border-radius:50%;cursor:pointer" onclick="onChangeProfilePic()">
  </div>
</header>

<div id="main">
  <aside id="sidebar">
    <button onclick="showSection('dashboard')">Dashboard</button>
    <button onclick="showSection('sharedBots')">Shared Bots</button>
    <button onclick="showSection('trader')">D-Trader</button>
    <button onclick="showSection('charts')">Charts</button>
  </aside>

  <div id="content">
    <section id="dashboard" class="section active-section">
      <h2>Dashboard</h2>
      <p>Welcome to your Merrick Trade City panel. Below is your recent performance.</p>
      <canvas id="portfolioChart"></canvas>
    </section>

    <section id="sharedBots" class="section">
      <h2>Shared Admin Bots</h2>
      <div id="sharedContainer"></div>
    </section>

    <section id="trader" class="section">
      <h2>Live D-Trader</h2>
      <div id="tvFrameWrap"></div>
      <div style="margin-top:15px">
        <button class="btn" onclick="connectDeriv()">Connect Deriv</button>
        <button class="btn" onclick="requestProposal()">Get Proposal</button>
        <button class="btn" onclick="buyContract()">Buy</button>
        <div id="proposalInfo" style="margin-top:10px;font-size:0.9rem;color:#ccc"></div>
      </div>
    </section>

    <section id="charts" class="section">
      <h2>Charts</h2>
      <div id="tvChartWrap"></div>
    </section>
  </div>
</div>

<div id="loadingOverlay">
  <img src="https://i.imgur.com/M6aJQKx.gif" alt="Loading..." width="80">
  <p id="loadingSub" style="margin-top:10px">Loading Merrick Trade City...</p>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const GITHUB_OWNER = 'KevTech-svg';
const GITHUB_REPO = 'Merrick-Trade-City';
const ADMIN_BOTS_PATH = 'admin-bots.json';

let usersData = {};
let currentUser = null;
let currentUserEmail = null;
let ws = null;
let lastProposal = null;

/* Helpers */
function qs(sel){ return document.querySelector(sel); }
function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active-section'));
  qs('#' + id).classList.add('active-section');
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Deriv */
function connectDeriv(){
  if(ws){ ws.close(); }
  ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=109286');
  ws.onopen = ()=>{ console.log('Connected to Deriv'); };
  ws.onmessage = (e)=>handleDerivMsg(JSON.parse(e.data));
  ws.onerror = (e)=>console.error('WS error',e);
}
function handleDerivMsg(msg){
  if(msg.error){ console.error('Deriv error:', msg.error); return; }
  if(msg.msg_type==='proposal'){ lastProposal = msg.proposal; qs('#proposalInfo').textContent = Proposal ask: ${lastProposal.ask_price} | id: ${lastProposal.id}; }
  if(msg.msg_type==='buy'){ qs('#proposalInfo').textContent = Bought contract id: ${msg.buy.contract_id} — status: ${msg.buy.contract_type || 'N/A'}; }
}
function requestProposal(){
  if(!ws||ws.readyState!==1){ alert('Connect first'); return; }
  ws.send(JSON.stringify({proposal:1, amount:1, basis:'stake', contract_type:'CALL', currency:'USD', duration:1, duration_unit:'m', symbol:'R_100'}));
}
function buyContract(){
  if(!ws||!lastProposal){ alert('No proposal yet'); return; }
  ws.send(JSON.stringify({buy: lastProposal.id, price: 1}));
}

/* GitHub load */
async function loadAdminBotsFromGitHubReadOnly(){
  const url = https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(ADMIN_BOTS_PATH)};
  const res = await fetch(url);
  if(!res.ok){ console.error('GitHub fetch error',res.status); return; }
  const data = await res.json();
  const json = JSON.parse(atob(data.content));
  usersData = json;
  buildBotsUI();
}

/* UI builder */
function buildBotsUI(){
  const c = qs('#sharedContainer');
  c.innerHTML = '';
  Object.values(usersData).forEach(bot=>{
    const d = document.createElement('div');
    d.className = 'bot-card';
    d.innerHTML = `<h4>${escapeHtml(bot.name)}</h4><div class="muted">Shared by Admin</div>
      <div style="margin-top:8px"><button class="btn" onclick="loadSharedBot('${escapeHtml(bot.name)}')">Load</button></div>`;
    c.appendChild(d);
  });
}
function loadSharedBot(name){
  alert(Loaded bot: ${name});
}

/* Portfolio Chart */
function setupPortfolioChart(){
  const ctx = qs('#portfolioChart');
  const labels = Array.from({length:10},(_,i)=>Day ${i+1});
  const data = labels.map(()=>Math.floor(80+Math.random()*40));
  new Chart(ctx,{type:'line',data:{labels,
    datasets:[{label:'Portfolio Value',data,borderColor:'#2ea043',backgroundColor:'rgba(46,160,67,0.2)',fill:true,tension:0.3}]},
    options:{plugins:{legend:{labels:{color:'#eee'}}},scales:{x:{ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}});
}

/* TradingView embeds */
function embedTradingView(targetId, symbol='OANDA:XAUUSD'){
  const w = qs('#' + targetId);
  if(!w) return;
  w.innerHTML = `
    <iframe
      src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=1&hidesidetoolbar=1&theme=dark&style=1"
      width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;
}

/* Profile picture change */
function onChangeProfilePic(){
  const url = prompt('Enter new profile image URL:');
  if(!url) return;
  qs('#profilePic').src = url;
  if(currentUser){ currentUser.avatar = url; usersData[currentUser.email] = currentUser; }
}

/* Initialize */
async function init(){
  qs('#loadingSub').textContent = 'Initializing data...';
  await loadAdminBotsFromGitHubReadOnly();
  qs('#userName').textContent = 'Guest';
  setupPortfolioChart();
  embedTradingView('tvFrameWrap','OANDA:XAUUSD');
  embedTradingView('tvChartWrap','DERIV:1HZ100V');
  setTimeout(()=>qs('#loadingOverlay').classList.add('loading-hidden'),1500);
}
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
